<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SVG Line Charts</title>

  <!-- SVG Style -->
  <link rel="stylesheet" type="text/css" href="svgStyle.css" media="screen" />
  <script src="svgUtils.js"></script>
</head>

<body>
  <div class="options">
    <input type="checkbox" onclick="clickOnlyL50(event)" checked>Only L50 samplings</input>
    <input type="checkbox" onclick="clickOnlyTarget(event)" checked>Only +500 samplings</input>
  </div>
  <div id="charts-container"></div>

  <script>
    // Create species object
    let speciesData = {};
    let onlyShowTarget = true;

    let url = 'data/trawlingData/trawling_sizes.json';
    //let url = 'data/purseSeineData/ps_sizes.json'
    fetch(url).then(r => r.json()).then(res => {

      // Organize data to make plots easier
      // Sort by species
      res.forEach(item => {
        if (speciesData[item.ScientificName] == undefined)
          speciesData[item.ScientificName] = {
            'rawData': [],
            'byYear': {},
            'bySeason': {},
            'byGround': {},
            'byPortArea': {},
            'bySize': {},
            'breadcrumb': '',
            'rangeSize': [Infinity, -Infinity],
            'rangeNumInd': [Infinity, -Infinity],
            // Mininum size, Maturity size
            'L50': item.L50,
            'MCRS': item.MCRS,
          };
        speciesData[item.ScientificName].rawData.push(item);
        // Species > Size
        if (speciesData[item.ScientificName].bySize[item.Size] == undefined) {
          speciesData[item.ScientificName].bySize[item.Size] = {
            'rawData': [],
            'numInd': 0,
          }
        }
        // bySize
        speciesData[item.ScientificName].bySize[item.Size].rawData.push(item);
        speciesData[item.ScientificName].bySize[item.Size].numInd += parseFloat(item.Abundance_NSpecimen_Km2 || item.Abundance_NSpecimen);
      });


      // Sort by year, season and ground
      Object.keys(speciesData).forEach(sName => {
        let specData = speciesData[sName];

        // Find X Y ranges per species
        findSizeAndNumIndRanges(specData, sName);
        // L50 and MCRS defined previously

        const categories = ['byYear', 'bySeason', 'byGround', 'byPortArea'];
        const categoriesKeyAttr = ['Year', 'Season', 'FishingGroundType', 'PortArea'];
        // Iterate raw data
        specData.rawData.forEach(item => {
          // Fill data for the different categories
          for (let i = 0; i < categories.length; i++) {
            // Species > Year, Season, Ground...
            fillDataStruct(specData, item, categories[i], categoriesKeyAttr[i]); // fillDataStruct(specData, item, 'byYear', 'Year');
          }
        });
        // Find X Y ranges per species and categories
        for (let i = 0; i < categories.length; i++) {
          Object.keys(specData[categories[i]]).forEach(key => {
            findSizeAndNumIndRanges(specData[categories[i]][key], sName);
            specData[categories[i]][key].L50 = specData.L50;
            specData[categories[i]][key].MCRS = specData.MCRS;
          });
        }
      });



      //debugger;
      showBy('byYear');

    });











    // Create and add plots to DOM
    const plotLengthDistribution = (speciesData, keyClassName) => {

      let container = document.getElementById('charts-container');
      container.innerHTML = '';

      let numPlots = Object.keys(speciesData).length;
      const generateRandomColors = function (number) {
        let colors = [];
        for (let i = 0; i < number; i++) {
          colors[i] = "hsla(" + 360 * Math.random() + ',' +
            (25 + 70 * Math.random()) + '%,' +
            (50 + 10 * Math.random()) + '%,' +
            '0.85)'
        }
        return colors
      }
      const colors = generateRandomColors(numPlots);

      for (let i = 0; i < numPlots; i++) {
        let specData = speciesData[Object.keys(speciesData)[i]];
        if (specData.rawData.length < 500 && onlyShowTarget)
          continue;
        if (specData.L50 == undefined)
          continue;

        let speciesContainer = document.createElement('div');
        speciesContainer.classList.add('species-container');

        // Create SVG
        let htmlEl = createPlotHTMLEl(specData, Object.keys(speciesData)[i], 'Longitude', 'Abundance', colors[i]);

        // Add to DOM
        container.appendChild(htmlEl);
      }

    }




    // On click events
    let currentKeyClassName = 'byYear';
    const showBy = function (keyClassName) {
      keyClassName = keyClassName || currentKeyClassName;
      plotLengthDistribution(speciesData, keyClassName);
      currentKeyClassName = keyClassName;
    }
    const clickOnlyTarget = function (e) {
      onlyShowTarget = e.target.checked;
      // Repaint
      plotLengthDistribution(speciesData, currentKeyClassName);
    }
  </script>
</body>

</html>